var initialTouchPositionX = -1;
var initialTouchPositionY = -1;
var lastTouchPositionX = -1;
var touchStartTimestamp = 0;
var animationDuration = 200;
var criticalVelocity = 0.5;
var criticalDistance = 80;
var drawerWidth = 260;
var isOpen = false;
var edgeWidth = 0;

function observePropChanges(newVal, oldVal, ownerInstance, currentInstance) {
    if (!ownerInstance || !ownerInstance.getState) {
        return;
    }
    var state = ownerInstance.getState() || {};
    state.currentInstance = currentInstance;

    if (newVal) {
        var data = JSON.parse(newVal);
        animationDuration = data.duration || 200;
        isOpen = !!data.modelValue;
        edgeWidth = data.edgeWidth || 0;

        if (data.width) {
            var widthStr = '' + data.width;
            if (widthStr.indexOf('px') !== -1) {
                drawerWidth = parseFloat(widthStr) || drawerWidth;
            } else {
                drawerWidth = parseFloat(widthStr) || drawerWidth;
            }
        }

        var transition = 'all ' + animationDuration + 'ms ease-out';
        var transform = isOpen
            ? 'translate3d(0,0,0)'
            : 'translate3d(' + -drawerWidth + 'px,0,0)';
        applyTransformation(transform, currentInstance, true, transition);
        
        if (isOpen) {
            notifySlideProgress(1, ownerInstance, currentInstance);
        } else {
            notifySlideProgress(0, ownerInstance, currentInstance);
        }
    }
}

function handleTouchstart(e, ownerInstance) {
    if (!ownerInstance || !ownerInstance.getState) {
        return;
    }
    
    var state = ownerInstance.getState();
    if (!state) {
        return;
    }
    
    var touch = extractTouchFromEvent(e);
    var startX = touch.clientX;
    var startY = touch.clientY;

    if (!isOpen && edgeWidth > 0 && startX > edgeWidth) {
        return;
    }

    initialTouchPositionX = startX;
    initialTouchPositionY = startY;
    lastTouchPositionX = startX;
    touchStartTimestamp = e.timeStamp || Date.now();

    var currentInstance = state.currentInstance;
    if (currentInstance) {
        notifySlideProgress(isOpen ? 1 : 0, ownerInstance, currentInstance);
    }
    
    state.touchStarted = true;
}

function handleTouchmove(e, ownerInstance) {
    if (initialTouchPositionX < 0 || initialTouchPositionY < 0) {
        return;
    }
    
    if (!ownerInstance || !ownerInstance.getState) {
        return;
    }
    
    var state = ownerInstance.getState();
    if (!state || !state.currentInstance) {
        return;
    }
    
    var touch = extractTouchFromEvent(e);
    var currentX = touch.clientX;
    var currentY = touch.clientY;
    
    var deltaX = currentX - initialTouchPositionX;
    var deltaY = currentY - initialTouchPositionY;
    var deltaXAbs = Math.abs(deltaX);
    var deltaYAbs = Math.abs(deltaY);
    
    if (deltaXAbs <= deltaYAbs * 2.0 && deltaXAbs < 15) {
        if (deltaYAbs > 8) {
            initialTouchPositionX = -1;
            initialTouchPositionY = -1;
            return;
        }
    }
    
    var currentInstance = state.currentInstance;

    var targetOffset;
    if (isOpen) {
        targetOffset = Math.min(0, Math.max(-drawerWidth, deltaX));
    } else {
        targetOffset = Math.min(0, Math.max(-drawerWidth, -drawerWidth + deltaX));
    }

    applyTransformation('translate3d(' + targetOffset + 'px,0,0)', currentInstance, false, '');

    var progress = 1 + targetOffset / drawerWidth;
    progress = Math.max(0, Math.min(1, progress));

    notifySlideProgress(progress, ownerInstance, currentInstance);

    lastTouchPositionX = currentX;
}

function handleTouchend(e, ownerInstance) {
    if (!ownerInstance || !ownerInstance.getState) {
        initialTouchPositionX = -1;
        initialTouchPositionY = -1;
        return;
    }
    
    var state = ownerInstance.getState();
    if (!state || !state.currentInstance) {
        initialTouchPositionX = -1;
        initialTouchPositionY = -1;
        return;
    }
    
    var endTime = e.timeStamp || Date.now();
    var currentInstance = state.currentInstance;
    var touch = extractTouchFromEvent(e);
    var endX = touch.clientX;
    var endY = touch.clientY;
    
    var deltaX = endX - initialTouchPositionX;
    var deltaY = endY - initialTouchPositionY;
    var deltaXAbs = Math.abs(deltaX);
    var deltaYAbs = Math.abs(deltaY);
    
    var isHorizontalSwipe = deltaXAbs > deltaYAbs * 2.0;
    
    if (!isHorizontalSwipe) {
        if (deltaXAbs > 0) {
            if (isOpen) {
                applyTransformation('translate3d(0,0,0)', currentInstance, true, 'all ' + animationDuration + 'ms ease-out');
                notifySlideProgress(1, ownerInstance, currentInstance);
            } else {
                applyTransformation('translate3d(' + -drawerWidth + 'px,0,0)', currentInstance, true, 'all ' + animationDuration + 'ms ease-out');
                notifySlideProgress(0, ownerInstance, currentInstance);
            }
        }
        initialTouchPositionX = -1;
        initialTouchPositionY = -1;
        return;
    }
    
    var distance = deltaX;
    var absDistance = deltaXAbs;

    if (absDistance < 10) {
        initialTouchPositionX = -1;
        initialTouchPositionY = -1;
        return;
    }

    var timeDelta = Math.max(1, endTime - touchStartTimestamp);
    var velocity = (endX - lastTouchPositionX) / timeDelta;

    var shouldOpen;
    if (isOpen) {
        shouldOpen = !(distance < -criticalDistance || velocity < -criticalVelocity);
    } else {
        shouldOpen = distance > criticalDistance || velocity > criticalVelocity;
    }

    if (shouldOpen) {
        applyTransformation('translate3d(0,0,0)', currentInstance, true, 'all ' + animationDuration + 'ms ease-out');
        isOpen = true;
        notifySlideProgress(1, ownerInstance, currentInstance);
        if (ownerInstance && ownerInstance.callMethod) {
            ownerInstance.callMethod('handleOpen');
        }
    } else {
        applyTransformation('translate3d(' + -drawerWidth + 'px,0,0)', currentInstance, true, 'all ' + animationDuration + 'ms ease-out');
        isOpen = false;
        notifySlideProgress(0, ownerInstance, currentInstance);
        if (ownerInstance && ownerInstance.callMethod) {
            ownerInstance.callMethod('handleClose');
        }
    }

    initialTouchPositionX = -1;
    initialTouchPositionY = -1;
}

function applyTransformation(transform, currentInstance, animate, transition) {
    if (!currentInstance) {
        return;
    }
    currentInstance.requestAnimationFrame(function() {
        if (!currentInstance) {
            return;
        }
        var stl = transform !== 'translate3d(0,0,0)' ? { transform: transform } : { transform: 'none' };
        if (animate) {
            stl.transition = transition || 'all .2s linear';
        } else {
            stl.transition = 'none';
        }
        currentInstance.setStyle(stl);
    });
}

function getInstance(ownerInstance) {
    if (!ownerInstance || !ownerInstance.getState) {
        return null;
    }
    var state = ownerInstance.getState();
    if (!state) {
        return null;
    }
    return state.currentInstance;
}

function extractTouchFromEvent(e) {
    return e.changedTouches ? e.changedTouches[0] : e.touches[0];
}

function notifySlideProgress(progress, ownerInstance, currentInstance) {
    if (ownerInstance && ownerInstance.callMethod) {
        var numProgress = typeof progress === 'number' ? progress : parseFloat(progress) || 0;
        ownerInstance.callMethod('handleSlideProgress', numProgress);
    }
}

module.exports = {
    handleTouchstart: handleTouchstart,
    handleTouchmove: handleTouchmove,
    handleTouchend: handleTouchend,
    observePropChanges: observePropChanges,
    notifySlideProgress: notifySlideProgress
};
